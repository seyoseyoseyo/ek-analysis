import re
import matplotlib.pyplot as plt
import sys
from selenium import webdriver
import time
import csv
from datetime import datetime, timedelta

SCROLL_PAUSE_TIME = 1.5


acc = sys.argv[1]
date_str = sys.argv[2]

filename = 'database/' + acc + '.csv'
start = datetime.strptime(date_str, "%d/%m/%Y")
today = datetime.today()
current = start

# url = 'https://twitter.com/search?l=&q=from%3Aexecutemalware%20since%3A2016-08-03%20until%3A2016-08-04&src=typd&lang=en'
# put all content of the webpage into a string
# driver = webdriver.PhantomJS('C:\phantomjs-2.1.1-windows\exe\phantomjs.exe')

def scroll():
  # Get scroll height
  last_height = driver.execute_script("return document.body.scrollHeight")
  
  while True:
    # Scroll down to bottom
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")

    # Wait to load page
    time.sleep(SCROLL_PAUSE_TIME)

    # Calculate new scroll height and compare with last scroll height
    new_height = driver.execute_script("return document.body.scrollHeight")
    if new_height == last_height:
        break
    last_height = new_height

while current.date() != today.date():
  nextday = current + timedelta(days = 1)
  currentstr = current.strftime('%Y-%m-%d')
  nextstr = nextday.strftime('%Y-%m-%d')
  print ("Exploring ", currentstr)
  url = 'https://twitter.com/search?l=&q=from%3A' + acc + '%20since%3A' + currentstr +  '%20until%3A' + nextstr + '&src=typd&lang=en'
  driver = webdriver.Chrome('C:\Python27\Scripts\chromedriver.exe')
  #driver = webdriver.Firefox()
  driver.get(url)
  scroll()
  html_content = driver.page_source #.encode('utf-8')
  indices = [s.start() for s in re.finditer('js-tweet-text-container', html_content)]
  if len(indices) > 20:
    print(len(indices), current.date())

  for index in indices:
    pos = index + 29
    while html_content[pos] != '>':
      pos += 1
    start_pos = pos + 1
    temp = start_pos
    while html_content[temp: temp + 4] != '</p>':
      temp += 1
    end_pos = temp
    output = []
    output.append(current)
    output.append(html_content[start_pos:end_pos])
    with open(filename, "a") as f:
      writer = csv.writer(f)
      writer.writerow(output)
  time.sleep(2)
  driver.close()
  current = nextday
